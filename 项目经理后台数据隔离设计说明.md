# 项目经理后台数据隔离设计说明

## 📋 数据隔离原则

### 🎯 核心原则
**每个项目经理只能访问和管理自己负责的项目相关数据，确保数据安全和权限边界清晰。**

## 🏗️ 数据隔离架构

### 1. **用户身份识别**
```javascript
// 前端获取当前用户信息
const currentUser = {
  id: 'PM001',
  name: '张经理', 
  role: 'project_manager',
  managedProjects: ['PRJ-2024-001', 'PRJ-2024-005', 'PRJ-2024-008']
}
```

### 2. **API数据过滤**
```javascript
// 后端API示例 - 根据项目经理ID过滤数据
GET /api/projects?managerId=${currentUser.id}
GET /api/tasks?projectId=IN(${managedProjectIds})
GET /api/team-members?projectId=IN(${managedProjectIds})
```

## 📊 各模块数据隔离实现

### 1. **项目经理仪表板**
- **统计数据**: 只统计当前项目经理负责的项目
- **项目列表**: 只显示负责的项目
- **团队成员**: 只显示参与其项目的成员
- **任务总数**: 只统计其项目下的任务

```javascript
// 示例：仪表板统计数据
const stats = {
  totalProjects: 3,        // 当前项目经理负责的项目总数
  activeProjects: 2,       // 当前项目经理进行中的项目
  teamMembers: 15,         // 参与其项目的成员总数（去重）
  completedTasks: 45       // 其项目下已完成的任务数
}
```

### 2. **项目详情管理**
- **项目列表**: 仅显示当前项目经理负责的项目
- **WBS任务树**: 只能查看和编辑自己项目的任务
- **甘特图监控**: 只显示自己项目的进度

### 3. **任务管理**
- **任务列表**: 只显示当前项目经理项目下的任务
- **任务分配**: 只能分配给参与其项目的团队成员
- **进度更新**: 只能更新自己项目的任务进度

### 4. **团队管理**
- **成员列表**: 只显示参与其项目的团队成员
- **成员添加**: 可从公司人员库中邀请新成员加入项目
- **权限管理**: 只能管理自己项目团队成员的项目内权限

### 5. **项目归档**
- **已完成项目**: 只显示该项目经理负责的已完成项目
- **归档文档**: 只能访问自己项目的归档文档
- **统计分析**: 只统计自己项目的归档数据

## 🔒 权限控制实现

### 1. **前端权限控制**
```javascript
// 用户权限检查
const hasProjectAccess = (projectId) => {
  return currentUser.managedProjects.includes(projectId)
}

// 路由守卫
router.beforeEach((to, from, next) => {
  const projectId = to.params.projectId
  if (projectId && !hasProjectAccess(projectId)) {
    next('/unauthorized')
  } else {
    next()
  }
})
```

### 2. **后端权限验证**
```javascript
// API权限中间件
const projectManagerAuthMiddleware = (req, res, next) => {
  const { projectId } = req.params
  const { managerId } = req.user
  
  // 验证项目经理是否有权限访问该项目
  if (!isProjectManager(managerId, projectId)) {
    return res.status(403).json({ message: '无权限访问该项目' })
  }
  
  next()
}
```

## 📋 数据库查询优化

### 1. **项目数据查询**
```sql
-- 获取项目经理负责的项目
SELECT * FROM projects 
WHERE manager_id = :currentManagerId

-- 获取项目相关任务
SELECT t.* FROM tasks t
JOIN projects p ON t.project_id = p.id
WHERE p.manager_id = :currentManagerId
```

### 2. **团队成员查询**
```sql
-- 获取参与项目经理项目的团队成员
SELECT DISTINCT u.* FROM users u
JOIN project_members pm ON u.id = pm.user_id
JOIN projects p ON pm.project_id = p.id
WHERE p.manager_id = :currentManagerId
```

## 🎨 UI层面的体现

### 1. **移除不必要的搜索项**
- ✅ 已移除"项目经理"搜索字段（因为都是自己的项目）
- ✅ 简化筛选条件，只保留真正有用的过滤项

### 2. **个性化展示**
- 在页面标题或用户信息中显示"我的项目"、"我的团队"等个性化文案
- 统计数据明确标注为个人维度数据

### 3. **权限边界提示**
- 在适当位置添加说明："您只能查看和管理自己负责的项目"
- 对于无权限操作给出友好提示

## 🔄 数据同步与更新

### 1. **实时数据同步**
- 当项目经理被分配新项目时，其后台数据自动更新
- 当项目完成或转移时，相关数据从其视图中移除

### 2. **权限变更处理**
- 项目经理角色变更时，重新计算可访问的数据范围
- 支持项目转移功能，新旧项目经理平滑交接

## 📝 开发实施建议

### 1. **后端实现**
```javascript
// 建议在后端实现通用的数据过滤装饰器
@ProjectManagerDataFilter
async getProjects(managerId) {
  // 自动根据managerId过滤数据
  return await ProjectService.getProjectsByManager(managerId)
}
```

### 2. **前端实现**  
```javascript
// 建议在Pinia Store中实现数据隔离
const useProjectManagerStore = defineStore('projectManager', {
  state: () => ({
    currentManager: null,
    managedProjects: [],
    teamMembers: [],
    tasks: []
  }),
  
  actions: {
    async fetchManagerData() {
      // 获取当前项目经理的所有相关数据
      this.managedProjects = await api.getManagerProjects()
      this.teamMembers = await api.getManagerTeamMembers() 
      this.tasks = await api.getManagerTasks()
    }
  }
})
```

## ⚠️ 注意事项

1. **数据一致性**: 确保前后端的权限控制逻辑一致
2. **性能优化**: 对频繁查询的数据进行适当缓存
3. **审计日志**: 记录所有数据访问操作，便于安全审计
4. **测试覆盖**: 重点测试权限边界和数据隔离效果

---

> 通过以上数据隔离设计，确保每个项目经理都有独立、安全、高效的工作环境，提升系统的安全性和用户体验。
