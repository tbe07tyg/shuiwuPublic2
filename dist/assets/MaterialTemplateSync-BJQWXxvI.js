import{_ as J,h as E,d as K,i as W,a1 as X,A as Y,c as p,a as u,b as C,j as d,p as v,x as m,z as Z,t as x,w as c,l as h,F as ee,s as ae,a2 as te,f,m as se,o as r,R as le,n as oe,k as U,a3 as ie,D as ne,Q as de,a4 as re}from"./index-CLrs7Nd9.js";import{m as b}from"./materialTemplate-DHg93JQh.js";import{U as ue}from"./UploadOutlined-U6qGJXGO.js";const ce={class:"material-template-sync"},pe={class:"material-submit-section"},me={class:"section-header"},_e={class:"header-actions"},ve={key:0,class:"material-list"},fe={class:"material-info"},ye={class:"material-title"},he={class:"category-name"},ge={key:0,class:"material-desc"},Ce={key:1,class:"template-download"},xe={class:"upload-area"},ke={key:0,class:"uploaded-file"},qe={class:"file-info"},Re={class:"file-name"},be={key:1,class:"empty-state"},we={key:2,class:"submit-summary"},ze={__name:"MaterialTemplateSync",props:{businessType:{type:String,required:!0,validator:k=>["apply","opening","midterm","acceptance"].includes(k)},autoLoad:{type:Boolean,default:!0},showActions:{type:Boolean,default:!0}},emits:["files-change","validation-change","config-update"],setup(k,{expose:O,emit:$}){const g=k,_=$,B=se(),w=E(!1),i=E([]),n=E(new Map),{businessTypeMap:L}=b,y=K(()=>i.value.filter(a=>a.isRequired).every(a=>n.value.has(a.id))),M=()=>{const e=i.value.length,a=i.value.filter(o=>o.isRequired).length,s=n.value.size,l=i.value.filter(o=>o.isRequired).filter(o=>n.value.has(o.id)).length;return y.value?`已上传 ${s}/${e} 个文件，所有必传材料已完成`:`已上传 ${l}/${a} 个必传材料，还需上传 ${a-l} 个必传文件`},z=e=>n.value.get(e),N=async()=>{await q()},q=async()=>{w.value=!0;try{const e=b.getConfigsByBusinessType(g.businessType);i.value=e.sort((a,s)=>(a.sortOrder||0)-(s.sortOrder||0)),_("config-update",e)}catch(e){console.error("加载配置失败:",e),f.error("加载配置失败")}finally{w.value=!1}},A=(e,a)=>{if(e.size>52428800)return f.error("文件大小不能超过50MB"),!1;if(a.templateFileName){const l=a.templateFileName.split(".").pop().toLowerCase(),o=e.name.split(".").pop().toLowerCase(),R={docx:["docx","doc","pdf"],doc:["docx","doc","pdf"],xlsx:["xlsx","xls"],xls:["xlsx","xls"],pdf:["pdf","docx","doc"]}[l]||[l];if(!R.includes(o))return f.error(`请上传 ${R.join("、")} 格式的文件`),!1}return n.value.set(a.id,e),_("files-change",{configId:a.id,file:e,action:"add"}),_("validation-change",{allRequiredUploaded:y.value,uploadedCount:n.value.size,totalCount:i.value.length}),f.success(`文件 "${e.name}" 已选择`),!1},D=e=>{const a=n.value.get(e);a&&(n.value.delete(e),_("files-change",{configId:e,file:a,action:"remove"}),_("validation-change",{allRequiredUploaded:y.value,uploadedCount:n.value.size,totalCount:i.value.length}),f.success("文件已移除"))},P=e=>{f.info(`正在下载模板：${e.templateFileName}`)},V=()=>{B.push("/settings/material-template")},I=()=>{const e=[];return n.value.forEach((a,s)=>{const l=i.value.find(o=>o.id===s);e.push({configId:s,config:l,file:a})}),e},j=()=>({valid:y.value,missingFiles:i.value.filter(e=>e.isRequired&&!n.value.has(e.id)).map(e=>e.categoryName)}),G=()=>{n.value.clear(),_("validation-change",{allRequiredUploaded:!1,uploadedCount:0,totalCount:i.value.length}),f.success("已清空所有文件")};let F=null;const Q=()=>{F=b.registerPageUpdateListener(g.businessType,e=>{i.value=e.sort((l,o)=>(l.sortOrder||0)-(o.sortOrder||0));const a=new Set(e.map(l=>l.id)),s=[];n.value.forEach((l,o)=>{a.has(o)||s.push(o)}),s.forEach(l=>{n.value.delete(l)}),_("config-update",e),s.length>0&&_("validation-change",{allRequiredUploaded:y.value,uploadedCount:n.value.size,totalCount:i.value.length})})};return W(async()=>{g.autoLoad&&(await b.initConfigs(),await q()),Q()}),X(()=>{F&&F()}),Y(()=>g.businessType,async()=>{g.autoLoad&&await q()},{immediate:!1}),O({refreshConfigs:N,getAllUploadedFiles:I,validateRequiredFiles:j,clearAllFiles:G,loadConfigs:q}),(e,a)=>{const s=h("a-button"),l=h("a-tag"),o=h("a-tooltip"),S=h("a-upload"),R=h("a-empty"),H=h("a-alert");return r(),p("div",ce,[u("div",pe,[u("div",me,[u("h4",null,[d(m(Z)),v(" "+x(m(L)[k.businessType]||"材料")+"提交 ",1)]),u("div",_e,[d(s,{type:"link",size:"small",onClick:N,loading:w.value},{default:c(()=>[d(m(le)),a[0]||(a[0]=v(" 刷新配置 ",-1))]),_:1,__:[0]},8,["loading"])])]),i.value.length>0?(r(),p("div",ve,[(r(!0),p(ee,null,ae(i.value,t=>(r(),p("div",{key:t.id,class:oe(["material-item",{required:t.isRequired}])},[u("div",fe,[u("div",ye,[u("span",he,[v(x(t.categoryName)+" ",1),t.isRequired?(r(),U(l,{key:0,color:"red",size:"small"},{default:c(()=>a[1]||(a[1]=[v("必传",-1)])),_:1,__:[1]})):(r(),U(l,{key:1,color:"blue",size:"small"},{default:c(()=>a[2]||(a[2]=[v("选传",-1)])),_:1,__:[2]}))]),t.description?(r(),U(o,{key:0,title:t.description},{default:c(()=>[d(m(ie),{class:"info-icon"})]),_:2},1032,["title"])):C("",!0)]),t.description?(r(),p("div",ge,x(t.description),1)):C("",!0),t.templateFileName?(r(),p("div",Ce,[d(s,{type:"link",size:"small",onClick:T=>P(t),class:"template-link"},{default:c(()=>[d(m(ne)),v(" 下载模板："+x(t.templateFileName),1)]),_:2},1032,["onClick"])])):C("",!0)]),u("div",xe,[d(S,{name:`file_${t.id}`,multiple:!1,"show-upload-list":!1,"before-upload":T=>A(T,t),class:"material-upload"},{default:c(()=>[d(s,{type:"primary",size:t.isRequired?"default":"small",danger:t.isRequired&&!z(t.id)},{default:c(()=>[d(m(ue)),a[3]||(a[3]=v(" 选择文件 ",-1))]),_:2,__:[3]},1032,["size","danger"])]),_:2},1032,["name","before-upload"]),z(t.id)?(r(),p("div",ke,[u("div",qe,[d(m(de)),u("span",Re,x(z(t.id).name),1),d(s,{type:"link",size:"small",danger:"",onClick:T=>D(t.id)},{default:c(()=>[d(m(re))]),_:2},1032,["onClick"])])])):C("",!0)])],2))),128))])):(r(),p("div",be,[d(R,{image:m(te).PRESENTED_IMAGE_SIMPLE,description:"暂无配置的材料类目"},{default:c(()=>[d(s,{type:"primary",onClick:V},{default:c(()=>a[4]||(a[4]=[v(" 前往配置 ",-1)])),_:1,__:[4]})]),_:1},8,["image"])])),i.value.length>0?(r(),p("div",we,[d(H,{type:y.value?"success":"warning",message:M(),"show-icon":""},null,8,["type","message"])])):C("",!0)])])}}},Ue=J(ze,[["__scopeId","data-v-667164fa"]]);export{Ue as M};
