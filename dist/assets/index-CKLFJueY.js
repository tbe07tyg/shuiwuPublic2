import{_ as ye,h as S,d as F,k as q,o as m,w as a,a as o,c as b,b as N,j as i,t as c,l as g,p as d,n as he,F as ie,s as ae,x as B,U as Se,f as T,E as Te,B as ge,e as De,A as fe,v as xe,Q as Ce,O as Ie,a4 as Ae,a8 as je,i as qe,a1 as Ue,q as Z,m as Ne,R as Oe,C as Me}from"./index-BG3bheTR.js";import{U as we}from"./UploadOutlined-RXM_KW39.js";import{U as Pe}from"./UserOutlined-eJbNfDXj.js";import{P as be}from"./ProjectOutlined-pD6foRXv.js";const Be={class:"task-detail-content"},He={class:"task-basic-info"},ze={class:"task-description"},Ee={class:"description-content"},Fe={class:"progress-tracking"},Re={class:"progress-actions"},Le={key:0,class:"material-submission"},Ve={class:"material-requirements"},We={class:"requirement-header"},Ye={class:"requirement-name"},Ke={class:"requirement-status"},Je={class:"material-actions"},Qe={class:"task-history"},Ge={key:0,class:"no-history"},Xe={class:"history-content"},Ze={class:"history-header"},et={class:"history-user"},tt={class:"history-action"},st={class:"history-time"},ot={class:"history-detail"},nt={key:0,class:"history-comments"},it={class:"comments-list"},at={class:"comment-header"},lt={class:"comment-user"},rt={class:"comment-time"},dt={class:"comment-content"},ut={class:"add-comment"},ct={__name:"TaskDetailDrawer",props:{visible:Boolean,task:Object},emits:["update:visible","update-progress","submit-material","task-completed"],setup(y,{emit:H}){const k=y,I=H,A=S({}),u=S(!1),C=S(null),D=F(()=>{var n;return((n=k.task)==null?void 0:n.operationHistory)||[]}),U=F(()=>{var s;return(s=k.task)!=null&&s.milestoneType?{opening:[{id:1,name:"开题报告",required:!0,submitted:!1},{id:2,name:"文献综述",required:!0,submitted:!1},{id:3,name:"技术路线图",required:!1,submitted:!1}],midterm:[{id:1,name:"中期检查报告",required:!0,submitted:!1},{id:2,name:"阶段性成果",required:!0,submitted:!1},{id:3,name:"进度总结",required:!1,submitted:!1}],acceptance:[{id:1,name:"验收报告",required:!0,submitted:!1},{id:2,name:"项目总结",required:!0,submitted:!1},{id:3,name:"成果展示",required:!1,submitted:!1}]}[k.task.milestoneType]||[]:[]});F(()=>{var n,s,_,p;return[{id:1,type:"assign",action:"任务已分配",createdAt:(n=k.task)==null?void 0:n.assignedAt,note:"项目经理分配了此任务"},{id:2,type:"start",action:"开始执行任务",createdAt:(s=k.task)==null?void 0:s.startedAt,note:null},{id:3,type:"progress",action:"更新任务进度",createdAt:(_=k.task)==null?void 0:_.lastUpdateAt,note:(p=k.task)==null?void 0:p.progressNote}].filter(j=>j.createdAt)});const ee=()=>{I("task-completed",k.task)},x=n=>n!=null&&n.deadline?new Date(n.deadline)<new Date&&n.status!=="completed":!1,f=n=>({pending:"orange","in-progress":"blue",review:"purple",completed:"green"})[n]||"default",l=n=>({pending:"待处理","in-progress":"进行中",review:"待审核",completed:"已完成"})[n]||n,V=n=>({high:"red",medium:"orange",low:"green"})[n]||"default",w=n=>({high:"高优先级",medium:"中优先级",low:"低优先级"})[n]||n,R=n=>n?n.status==="completed"?"success":x(n)?"exception":"active":"active",te=n=>({assign:"blue",start:"green",progress:"orange",complete:"green",material:"purple"})[n]||"blue",M=n=>({assign:Pe,start:ge,progress:ge,complete:Te,material:we})[n]||ge,K=n=>n?new Date(n).toLocaleString("zh-CN"):"-",z=n=>({progress_update:"更新了任务进度",material_submission:"提交了材料",status_change:"变更了任务状态",task_start:"开始了任务",task_complete:"完成了任务"})[n]||"执行了操作",J=n=>{switch(n.type){case"progress_update":const{oldProgress:s,newProgress:_,statusChange:p}=n.data;let j=`进度从 ${s}% 更新到 ${_}%`;return p&&(j+=`，状态从 ${l(p.from)} 变更为 ${l(p.to)}`),n.data.note&&(j+=`
备注：${n.data.note}`),j;case"material_submission":return`提交了 ${n.data.submissionCount} 个材料文件`;default:return"详细信息"}},W=n=>{if(!n)return"";const s=new Date,_=new Date(n),p=s-_;return p<6e4?"刚刚":p<36e5?`${Math.floor(p/6e4)}分钟前`:p<864e5?`${Math.floor(p/36e5)}小时前`:p<2592e6?`${Math.floor(p/864e5)}天前`:_.toLocaleDateString("zh-CN")},Q=n=>{C.value=n,u.value=!0},se=async n=>{const s=A.value[n.id];if(!s||!s.trim()){T.warning("请输入评论内容");return}const _={id:Date.now(),user:"张三(演示账号)",userId:"user_001",content:s.trim(),timestamp:new Date().toISOString()};n.comments||(n.comments=[]),n.comments.push(_),A.value[n.id]="",T.success("评论添加成功")};return(n,s)=>{const _=g("a-descriptions-item"),p=g("a-tag"),j=g("a-descriptions"),pe=g("a-progress"),E=g("a-button"),de=g("a-space"),me=g("a-input"),le=g("a-input-group"),G=g("a-timeline-item"),ue=g("a-timeline"),h=g("a-drawer");return m(),q(h,{visible:y.visible,title:"任务详情",placement:"right",width:"600","onUpdate:visible":s[2]||(s[2]=P=>n.$emit("update:visible",P))},{default:a(()=>{var P,Y,X,ce,_e;return[o("div",Be,[o("div",He,[o("h2",null,c((P=y.task)==null?void 0:P.title),1),i(j,{column:2,bordered:""},{default:a(()=>[i(_,{label:"所属项目"},{default:a(()=>{var t;return[d(c((t=y.task)==null?void 0:t.projectName),1)]}),_:1}),i(_,{label:"任务状态"},{default:a(()=>{var t;return[i(p,{color:f((t=y.task)==null?void 0:t.status)},{default:a(()=>{var e;return[d(c(l((e=y.task)==null?void 0:e.status)),1)]}),_:1},8,["color"])]}),_:1}),i(_,{label:"优先级"},{default:a(()=>{var t;return[i(p,{color:V((t=y.task)==null?void 0:t.priority)},{default:a(()=>{var e;return[d(c(w((e=y.task)==null?void 0:e.priority)),1)]}),_:1},8,["color"])]}),_:1}),i(_,{label:"截止时间"},{default:a(()=>{var t;return[o("span",{class:he({"text-red":x(y.task)})},c(K((t=y.task)==null?void 0:t.deadline)),3)]}),_:1}),i(_,{label:"分配人"},{default:a(()=>{var t;return[d(c(((t=y.task)==null?void 0:t.assignedByName)||"项目经理"),1)]}),_:1}),i(_,{label:"分配时间"},{default:a(()=>{var t;return[d(c(K((t=y.task)==null?void 0:t.assignedAt)),1)]}),_:1})]),_:1})]),o("div",ze,[s[3]||(s[3]=o("h3",null,"任务描述",-1)),o("div",Ee,c((Y=y.task)==null?void 0:Y.description),1)]),o("div",Fe,[s[6]||(s[6]=o("h3",null,"进度跟踪",-1)),i(pe,{percent:((X=y.task)==null?void 0:X.progress)||0,status:R(y.task),"stroke-width":8},null,8,["percent","status"]),o("div",Re,[i(de,null,{default:a(()=>{var t,e,v;return[i(E,{type:"primary",onClick:s[0]||(s[0]=$=>n.$emit("update-progress",y.task)),disabled:((t=y.task)==null?void 0:t.status)==="completed"},{default:a(()=>s[4]||(s[4]=[d(" 更新进度 ")])),_:1,__:[4]},8,["disabled"]),((e=y.task)==null?void 0:e.progress)===100&&((v=y.task)==null?void 0:v.status)!=="completed"?(m(),q(E,{key:0,type:"primary",onClick:ee},{default:a(()=>s[5]||(s[5]=[d(" 标记完成 ")])),_:1,__:[5]})):N("",!0)]}),_:1})])]),(ce=y.task)!=null&&ce.milestoneType?(m(),b("div",Le,[s[11]||(s[11]=o("h3",null,"材料提交",-1)),o("div",Ve,[(m(!0),b(ie,null,ae(U.value,t=>(m(),b("div",{key:t.id,class:"requirement-item"},[o("div",We,[o("span",Ye,c(t.name),1),t.required?(m(),q(p,{key:0,color:"red"},{default:a(()=>s[7]||(s[7]=[d("必需")])),_:1,__:[7]})):N("",!0)]),o("div",Ke,[t.submitted?(m(),q(p,{key:0,color:"green"},{default:a(()=>s[8]||(s[8]=[d(" 已提交 ")])),_:1,__:[8]})):(m(),q(p,{key:1,color:"orange"},{default:a(()=>s[9]||(s[9]=[d(" 待提交 ")])),_:1,__:[9]}))])]))),128))]),o("div",Je,[i(E,{type:"primary",onClick:s[1]||(s[1]=t=>n.$emit("submit-material",y.task)),disabled:((_e=y.task)==null?void 0:_e.status)==="completed"},{default:a(()=>[i(B(we)),s[10]||(s[10]=d(" 提交材料 "))]),_:1,__:[10]},8,["disabled"])])])):N("",!0),o("div",Qe,[s[14]||(s[14]=o("h3",null,"操作历史",-1)),D.value.length===0?(m(),b("div",Ge," 暂无操作历史 ")):(m(),q(ue,{key:1},{default:a(()=>[(m(!0),b(ie,null,ae(D.value,t=>(m(),q(G,{key:t.id,color:te(t.type)},{dot:a(()=>[(m(),q(Se(M(t.type))))]),default:a(()=>[o("div",Xe,[o("div",Ze,[o("span",et,c(t.user),1),o("span",tt,c(z(t.type)),1),o("span",st,c(W(t.timestamp)),1),i(E,{type:"link",size:"small",onClick:e=>Q(t)},{default:a(()=>s[12]||(s[12]=[d(" 查看详情 ")])),_:2,__:[12]},1032,["onClick"])]),o("div",ot,c(J(t)),1),t.comments&&t.comments.length>0?(m(),b("div",nt,[o("div",it,[(m(!0),b(ie,null,ae(t.comments,e=>(m(),b("div",{key:e.id,class:"comment-item"},[o("div",at,[o("span",lt,c(e.user),1),o("span",rt,c(W(e.timestamp)),1)]),o("div",dt,c(e.content),1)]))),128))])])):N("",!0),o("div",ut,[i(le,{compact:""},{default:a(()=>[i(me,{value:A.value[t.id],"onUpdate:value":e=>A.value[t.id]=e,placeholder:"添加评论...",onPressEnter:e=>se(t),style:{width:"calc(100% - 80px)"}},null,8,["value","onUpdate:value","onPressEnter"]),i(E,{type:"primary",onClick:e=>se(t),style:{width:"80px"}},{default:a(()=>s[13]||(s[13]=[d(" 评论 ")])),_:2,__:[13]},1032,["onClick"])]),_:2},1024)])])]),_:2},1032,["color"]))),128))]),_:1}))])])]}),_:1},8,["visible"])}}},pt=ye(ct,[["__scopeId","data-v-f30ce588"]]),mt={class:"progress-display"},vt={class:"completion-items"},gt={key:0,class:"progress-suggestion"},_t={__name:"ProgressUpdateModal",props:{visible:Boolean,task:Object},emits:["update:visible","confirm"],setup(y,{emit:H}){const k=y,I=H,A=S(!1),u=De({progress:0,note:"",estimatedCompletion:null,completedItems:[],issues:[],supportNeeded:""}),C={0:"0%",25:"25%",50:"50%",75:"75%",100:"100%"},D=F(()=>{var l;if(!k.task||u.progress<=(k.task.progress||0))return null;const f=u.progress-(k.task.progress||0);return u.progress===100?{type:"success",title:"任务即将完成",content:"恭喜！任务进度已达到100%，请确保所有工作项都已完成，然后可以标记任务为完成状态。"}:f>=30?{type:"success",title:"进度提升显著",content:`本次进度提升了${f}%，工作效率很高！请继续保持。`}:u.progress>=80&&((l=k.task)!=null&&l.milestoneType)?{type:"info",title:"可以开始准备材料",content:"任务进度已超过80%，如果这是里程碑任务，建议开始准备相关材料的提交。"}:null});fe(()=>k.task,f=>{f&&(u.progress=f.progress||0,u.note="",u.estimatedCompletion=null,u.completedItems=[],u.issues=[],u.supportNeeded="")}),fe(()=>k.visible,f=>{f&&k.task&&(u.progress=k.task.progress||0)});const U=f=>f&&f<xe().startOf("day"),ee=async()=>{var f,l;if(u.progress<(((f=k.task)==null?void 0:f.progress)||0)){T.error("进度不能倒退");return}if(u.progress>(((l=k.task)==null?void 0:l.progress)||0)+20&&!u.note.trim()){T.warning("进度提升较大，建议填写进度说明");return}A.value=!0;try{const V={progress:u.progress,note:u.note,estimatedCompletion:u.estimatedCompletion?u.estimatedCompletion.format("YYYY-MM-DD"):null,completedItems:u.completedItems,issues:u.issues,supportNeeded:u.supportNeeded,updateTime:new Date().toISOString()};await new Promise(w=>setTimeout(w,500)),I("confirm",V),Object.assign(u,{progress:0,note:"",estimatedCompletion:null,completedItems:[],issues:[],supportNeeded:""})}catch{T.error("更新失败，请重试")}finally{A.value=!1}},x=()=>{I("update:visible",!1)};return(f,l)=>{const V=g("a-slider"),w=g("a-form-item"),R=g("a-textarea"),te=g("a-date-picker"),M=g("a-checkbox"),K=g("a-checkbox-group"),z=g("a-select-option"),J=g("a-select"),W=g("a-input"),Q=g("a-form"),se=g("a-alert"),n=g("a-modal");return m(),q(n,{visible:y.visible,title:"更新任务进度",onOk:ee,onCancel:x,"onUpdate:visible":l[6]||(l[6]=s=>f.$emit("update:visible",s)),"ok-loading":A.value},{default:a(()=>[i(Q,{model:u,layout:"vertical"},{default:a(()=>[i(w,{label:"当前进度",required:""},{default:a(()=>[i(V,{value:u.progress,"onUpdate:value":l[0]||(l[0]=s=>u.progress=s),marks:C,"tip-formatter":s=>`${s}%`},null,8,["value","tip-formatter"]),o("div",mt,[l[7]||(l[7]=d(" 当前进度：")),o("strong",null,c(u.progress)+"%",1)])]),_:1}),i(w,{label:"进度说明"},{default:a(()=>[i(R,{value:u.note,"onUpdate:value":l[1]||(l[1]=s=>u.note=s),placeholder:"请描述当前进展情况、遇到的问题或需要的支持...",rows:4},null,8,["value"])]),_:1}),i(w,{label:"预计完成时间"},{default:a(()=>[i(te,{value:u.estimatedCompletion,"onUpdate:value":l[2]||(l[2]=s=>u.estimatedCompletion=s),style:{width:"100%"},"disabled-date":U},null,8,["value"])]),_:1}),i(w,{label:"完成情况详述"},{default:a(()=>[i(K,{value:u.completedItems,"onUpdate:value":l[3]||(l[3]=s=>u.completedItems=s)},{default:a(()=>[o("div",vt,[i(M,{value:"analysis"},{default:a(()=>l[8]||(l[8]=[d("需求分析")])),_:1,__:[8]}),i(M,{value:"design"},{default:a(()=>l[9]||(l[9]=[d("方案设计")])),_:1,__:[9]}),i(M,{value:"implementation"},{default:a(()=>l[10]||(l[10]=[d("代码实现")])),_:1,__:[10]}),i(M,{value:"testing"},{default:a(()=>l[11]||(l[11]=[d("功能测试")])),_:1,__:[11]}),i(M,{value:"documentation"},{default:a(()=>l[12]||(l[12]=[d("文档编写")])),_:1,__:[12]}),i(M,{value:"review"},{default:a(()=>l[13]||(l[13]=[d("代码审查")])),_:1,__:[13]})])]),_:1},8,["value"])]),_:1}),i(w,{label:"遇到的问题"},{default:a(()=>[i(J,{value:u.issues,"onUpdate:value":l[4]||(l[4]=s=>u.issues=s),mode:"multiple",placeholder:"选择遇到的问题（可选）","allow-clear":""},{default:a(()=>[i(z,{value:"technical"},{default:a(()=>l[14]||(l[14]=[d("技术难题")])),_:1,__:[14]}),i(z,{value:"resource"},{default:a(()=>l[15]||(l[15]=[d("资源不足")])),_:1,__:[15]}),i(z,{value:"coordination"},{default:a(()=>l[16]||(l[16]=[d("协调问题")])),_:1,__:[16]}),i(z,{value:"requirement"},{default:a(()=>l[17]||(l[17]=[d("需求不明确")])),_:1,__:[17]}),i(z,{value:"schedule"},{default:a(()=>l[18]||(l[18]=[d("时间紧张")])),_:1,__:[18]}),i(z,{value:"other"},{default:a(()=>l[19]||(l[19]=[d("其他问题")])),_:1,__:[19]})]),_:1},8,["value"])]),_:1}),i(w,{label:"需要的支持"},{default:a(()=>[i(W,{value:u.supportNeeded,"onUpdate:value":l[5]||(l[5]=s=>u.supportNeeded=s),placeholder:"描述需要项目经理或团队提供的支持..."},null,8,["value"])]),_:1})]),_:1},8,["model"]),D.value?(m(),b("div",gt,[i(se,{message:D.value.title,description:D.value.content,type:D.value.type,"show-icon":""},null,8,["message","description","type"])])):N("",!0)]),_:1},8,["visible","ok-loading"])}}},ft=ye(_t,[["__scopeId","data-v-dd501b69"]]),yt={class:"material-submission-content"},kt={class:"task-info"},bt={class:"material-requirements"},ht={class:"requirement-header"},wt={class:"requirement-name"},$t={class:"requirement-format"},Ct={class:"requirement-description"},Dt={class:"upload-item"},St={class:"file-info"},Tt={class:"file-name"},xt={class:"file-size"},It={class:"file-actions"},At={class:"submission-note"},jt={class:"completion-checklist"},qt={class:"checklist-items"},Ut={key:0,class:"submit-warning"},Nt={key:0,class:"file-preview"},Ot=["src"],Mt=["src"],Pt={key:2,class:"unsupported-preview"},Bt="/api/upload",Ht={__name:"MaterialSubmissionModal",props:{visible:Boolean,task:Object},emits:["update:visible","confirm"],setup(y,{emit:H}){const k=y,I=H,A=S(!1),u=S(!1),C=S(null),D=S(""),U=S([]),ee={Authorization:`Bearer ${localStorage.getItem("token")}`},x=De({}),f=F(()=>{var s;return(s=k.task)!=null&&s.milestoneType?{opening:[{id:"opening_report",name:"开题报告",required:!0,format:"Word文档 (.docx)",description:"包含研究背景、目标、方法、预期成果等内容的完整开题报告"},{id:"literature_review",name:"文献综述",required:!0,format:"Word文档 (.docx)",description:"相关领域的文献调研和综述分析"},{id:"technical_route",name:"技术路线图",required:!1,format:"图片或PDF (.png, .jpg, .pdf)",description:"项目实施的技术路线和流程图"}],midterm:[{id:"midterm_report",name:"中期检查报告",required:!0,format:"Word文档 (.docx)",description:"项目中期进展情况、阶段性成果和后续计划"},{id:"stage_results",name:"阶段性成果",required:!0,format:"多种格式",description:"已完成的研究成果、原型、代码或实验数据"}],acceptance:[{id:"acceptance_report",name:"验收报告",required:!0,format:"Word文档 (.docx)",description:"项目完整的验收报告和成果总结"},{id:"final_results",name:"最终成果",required:!0,format:"多种格式",description:"项目的最终交付成果和相关材料"}]}[k.task.milestoneType]||[]:[]}),l=F(()=>{const n=f.value.filter(_=>_.required),s=n.filter(_=>{var p;return((p=x[f.value.indexOf(_)])==null?void 0:p.length)>0});return s.length<n.length?{type:"warning",title:"必需材料未完成",content:`还有 ${n.length-s.length} 个必需材料未上传，请确保所有必需材料都已上传。`}:U.value.length<4?{type:"info",title:"请确认完成情况",content:"请确认所有完成项目，确保材料质量符合要求。"}:null});fe(()=>k.task,n=>{n&&f.value.forEach((s,_)=>{x[_]||(x[_]=[])})});const V=n=>{const s=n.size/1024/1024<50;return s||T.error("文件大小不能超过50MB"),s},w=n=>{n.file.status==="done"?T.success(`${n.file.name} 上传成功`):n.file.status==="error"&&T.error(`${n.file.name} 上传失败`)},R=n=>{C.value=n,u.value=!0},te=n=>["image/jpeg","image/png","image/gif","image/bmp"].includes(n.type)||/\.(jpg|jpeg|png|gif|bmp)$/i.test(n.name),M=n=>n.type==="application/pdf"||/\.pdf$/i.test(n.name),K=n=>{var _;const s=n.url||((_=n.response)==null?void 0:_.url);if(s){const p=document.createElement("a");p.href=s,p.download=n.name,p.click()}},z=n=>n?n<1024?n+" B":n<1024*1024?(n/1024).toFixed(1)+" KB":(n/1024/1024).toFixed(1)+" MB":"",J=n=>({opening:"blue",midterm:"purple",acceptance:"cyan"})[n]||"default",W=n=>({opening:"项目开题",midterm:"项目中期",acceptance:"项目验收"})[n]||n,Q=async()=>{const n=f.value.filter(_=>_.required);if(n.filter(_=>{var j;const p=f.value.indexOf(_);return((j=x[p])==null?void 0:j.length)>0}).length<n.length){T.error("请上传所有必需材料");return}if(U.value.length<3){T.error("请确认至少3项完成检查");return}A.value=!0;try{const _={taskId:k.task.id,milestoneType:k.task.milestoneType,materials:f.value.map((p,j)=>({requirementId:p.id,name:p.name,files:x[j]||[]})),note:D.value,completionChecks:U.value,submittedAt:new Date().toISOString()};await new Promise(p=>setTimeout(p,1e3)),I("confirm",_),D.value="",U.value=[],Object.keys(x).forEach(p=>{x[p]=[]})}catch{T.error("提交失败，请重试")}finally{A.value=!1}},se=()=>{I("update:visible",!1)};return(n,s)=>{const _=g("a-tag"),p=g("a-button"),j=g("a-upload"),pe=g("a-textarea"),E=g("a-checkbox"),de=g("a-checkbox-group"),me=g("a-alert"),le=g("a-modal");return m(),q(le,{visible:y.visible,title:"提交任务材料",width:"800px",onOk:Q,onCancel:se,"onUpdate:visible":s[4]||(s[4]=G=>n.$emit("update:visible",G)),"ok-loading":A.value},{default:a(()=>{var G,ue;return[o("div",yt,[o("div",kt,[o("h3",null,c((G=y.task)==null?void 0:G.title),1),i(_,{color:J((ue=y.task)==null?void 0:ue.milestoneType)},{default:a(()=>{var h;return[d(c(W((h=y.task)==null?void 0:h.milestoneType)),1)]}),_:1},8,["color"])]),o("div",bt,[s[7]||(s[7]=o("h4",null,"材料需求清单",-1)),(m(!0),b(ie,null,ae(f.value,(h,P)=>(m(),b("div",{key:h.id,class:"requirement-section"},[o("div",ht,[o("span",wt,[d(c(h.name)+" ",1),h.required?(m(),q(_,{key:0,color:"red",size:"small"},{default:a(()=>s[5]||(s[5]=[d("必需")])),_:1,__:[5]})):N("",!0)]),o("span",$t,c(h.format),1)]),o("div",Ct,c(h.description),1),i(j,{"file-list":x[P],"onUpdate:fileList":Y=>x[P]=Y,action:Bt,headers:ee,"before-upload":V,onChange:w,multiple:"","show-upload-list":{showDownloadIcon:!0,showRemoveIcon:!0,showPreviewIcon:!0},onPreview:R},{itemRender:a(({file:Y,actions:X})=>[o("div",Dt,[o("div",St,[i(B(Ce)),o("span",Tt,c(Y.name),1),o("span",xt,"("+c(z(Y.size))+")",1)]),o("div",It,[i(p,{type:"text",size:"small",onClick:X.preview},{default:a(()=>[i(B(Ie))]),_:2},1032,["onClick"]),i(p,{type:"text",size:"small",onClick:X.remove},{default:a(()=>[i(B(Ae))]),_:2},1032,["onClick"])])])]),default:a(()=>[i(p,null,{default:a(()=>[i(B(we)),s[6]||(s[6]=d(" 选择文件 "))]),_:1,__:[6]})]),_:2},1032,["file-list","onUpdate:fileList"])]))),128))]),o("div",At,[s[8]||(s[8]=o("h4",null,"提交说明",-1)),i(pe,{value:D.value,"onUpdate:value":s[0]||(s[0]=h=>D.value=h),placeholder:"请说明材料完成情况、主要内容概述、需要特别说明的问题等...",rows:4},null,8,["value"])]),o("div",jt,[s[13]||(s[13]=o("h4",null,"完成确认",-1)),i(de,{value:U.value,"onUpdate:value":s[1]||(s[1]=h=>U.value=h)},{default:a(()=>[o("div",qt,[i(E,{value:"content-complete"},{default:a(()=>s[9]||(s[9]=[d("材料内容完整，符合要求")])),_:1,__:[9]}),i(E,{value:"format-correct"},{default:a(()=>s[10]||(s[10]=[d("文件格式正确，可正常打开")])),_:1,__:[10]}),i(E,{value:"quality-check"},{default:a(()=>s[11]||(s[11]=[d("已进行质量检查，无明显错误")])),_:1,__:[11]}),i(E,{value:"deadline-aware"},{default:a(()=>s[12]||(s[12]=[d("了解截止时间，按时提交")])),_:1,__:[12]})])]),_:1},8,["value"])]),l.value?(m(),b("div",Ut,[i(me,{message:l.value.title,description:l.value.content,type:l.value.type,"show-icon":"",closable:""},null,8,["message","description","type"])])):N("",!0)]),i(le,{visible:u.value,"onUpdate:visible":s[3]||(s[3]=h=>u.value=h),title:"文件预览",footer:null,width:"80%"},{default:a(()=>{var h,P;return[C.value?(m(),b("div",Nt,[te(C.value)?(m(),b("img",{key:0,src:C.value.url||((h=C.value.response)==null?void 0:h.url),style:{width:"100%"}},null,8,Ot)):M(C.value)?(m(),b("iframe",{key:1,src:C.value.url||((P=C.value.response)==null?void 0:P.url),style:{width:"100%",height:"600px",border:"none"}},null,8,Mt)):(m(),b("div",Pt,[i(B(Ce),{style:{"font-size":"48px",color:"#999"}}),s[15]||(s[15]=o("p",null,"此文件类型暂不支持预览",-1)),i(p,{type:"primary",onClick:s[2]||(s[2]=Y=>K(C.value))},{default:a(()=>s[14]||(s[14]=[d(" 下载查看 ")])),_:1,__:[14]})]))])):N("",!0)]}),_:1},8,["visible"])]}),_:1},8,["visible","ok-loading"])}}},zt=ye(Ht,[["__scopeId","data-v-9129a604"]]),Et={class:"team-member-task-board"},Ft={class:"page-header"},Rt={class:"header-stats"},Lt={class:"system-info-section"},Vt={class:"task-filters"},Wt={class:"kanban-container"},Yt={class:"kanban-column pending-column"},Kt={class:"column-header"},Jt=["onDragstart","onClick"],Qt={class:"task-header"},Gt={class:"task-title"},Xt={class:"task-meta"},Zt={class:"task-content"},es={class:"task-description"},ts={class:"task-deadline"},ss={class:"task-project"},os={class:"task-assignment"},ns={class:"task-actions"},is={key:0,class:"empty-placeholder"},as={class:"kanban-column inprogress-column"},ls={class:"column-header"},rs=["onDragstart","onClick"],ds={class:"task-header"},us={class:"task-title"},cs={class:"task-meta"},ps={class:"task-content"},ms={class:"task-description"},vs={class:"task-progress"},gs={class:"task-deadline"},_s={class:"task-project"},fs={class:"task-assignment"},ys={class:"task-actions"},ks={key:0,class:"empty-placeholder"},bs={class:"kanban-column completed-column"},hs={class:"column-header"},ws=["onDragstart","onClick"],$s={class:"task-header"},Cs={class:"task-title"},Ds={class:"task-meta"},Ss={class:"task-content"},Ts={class:"task-description"},xs={class:"task-progress"},Is={class:"task-completion"},As={class:"task-project"},js={class:"task-assignment"},qs={key:0,class:"empty-placeholder"},Us={__name:"index",setup(y){Ne();const H=je(),k=S(null),I=S(null),A=S(!1),u=S(!1),C=S(!1),D=S(null);function U(){return"张三(演示账号)"}const ee=()=>`tm_tasks_${encodeURIComponent(U())}`,x=()=>{try{const t=localStorage.getItem(ee());if(!t)return null;const e=JSON.parse(t);if(Array.isArray(e))return e}catch(t){console.warn("加载本地任务失败:",t)}return null},f=()=>{try{localStorage.setItem(ee(),JSON.stringify(l.value))}catch(t){console.warn("保存本地任务失败:",t)}},l=S(x()||[{id:1,title:"系统需求分析",description:"完成项目需求分析文档，包括功能需求和非功能需求",status:"pending",priority:"high",progress:0,deadline:"2025-02-10",projectId:1,projectName:"科研管理系统",assignedBy:"张经理",createdAt:"2025-01-20",milestoneType:null},{id:9001,title:"联调-前端集成与验证",description:"在看板侧更新进度与评论，验证项目监控侧实时联动",status:"in-progress",priority:"high",progress:30,deadline:"2025-02-15",projectId:10001,projectName:"互动联调演示项目",assignedBy:"张经理",createdAt:"2025-01-22",milestoneType:null},{id:9002,title:"联调-材料提交流转",description:"从模板带出材料，成员提交，PM预审并转管理层",status:"pending",priority:"medium",progress:0,deadline:"2025-02-20",projectId:10001,projectName:"互动联调演示项目",assignedBy:"张经理",createdAt:"2025-02-01",milestoneType:"midterm"},{id:2,title:"数据库设计",description:"设计系统数据库表结构和关系",status:"in-progress",priority:"high",progress:65,deadline:"2025-02-05",projectId:1,projectName:"科研管理系统",assignedBy:"张经理",createdAt:"2025-01-18",milestoneType:null},{id:3,title:"项目开题材料准备",description:"准备项目开题所需的各类材料文档",status:"in-progress",priority:"medium",progress:30,deadline:"2025-02-15",projectId:2,projectName:"AI智能分析平台",assignedBy:"李主管",createdAt:"2025-01-22",milestoneType:"opening"},{id:4,title:"技术文档撰写",description:"完成技术架构和API文档的撰写",status:"completed",priority:"medium",progress:100,deadline:"2025-01-30",projectId:1,projectName:"科研管理系统",assignedBy:"张经理",createdAt:"2025-01-15",completedAt:"2025-01-28",milestoneType:null}]),V=S([{id:1,name:"科研管理系统"},{id:2,name:"AI智能分析平台"},{id:3,name:"数据可视化平台"},{id:10001,name:"互动联调演示项目"}]),w=F(()=>{const t=R.value;return{pending:t.filter(e=>e.status==="pending").length,inProgress:t.filter(e=>e.status==="in-progress").length,completed:t.filter(e=>e.status==="completed").length}}),R=F(()=>{let t=l.value;return k.value&&(t=t.filter(e=>e.projectId===k.value)),t}),te=F(()=>R.value.filter(t=>t.status==="pending").sort((t,e)=>{const v={high:3,medium:2,low:1},$=v[e.priority]-v[t.priority];return $!==0?$:new Date(t.deadline)-new Date(e.deadline)})),M=F(()=>R.value.filter(t=>t.status==="in-progress").sort((t,e)=>(e.progress||0)-(t.progress||0))),K=F(()=>R.value.filter(t=>t.status==="completed").sort((t,e)=>new Date(e.completedAt||0)-new Date(t.completedAt||0))),z=F(()=>{const t=R.value.length;if(t===0)return 0;const e=w.value.completed;return Math.round(e/t*100)}),J=(t,e)=>{D.value=e,t.dataTransfer.effectAllowed="move",t.dataTransfer.setData("text/html",t.target)},W=async(t,e)=>{if(t.preventDefault(),!D.value)return;const v=D.value,$=v.status;if($===e){D.value=null;return}v.status=e,e==="pending"?v.progress=0:e==="in-progress"&&v.progress===0?v.progress=10:e==="completed"&&(v.progress=100,v.completedAt=new Date().toISOString());try{await H.updateTask(String(v.projectId),String(v.id),{status:e,progress:v.progress,completedAt:v.completedAt}),T.success(`任务已移动到${Y(e)}`),f()}catch(O){console.error("更新任务状态失败:",O),T.error("更新任务状态失败"),v.status=$}D.value=null},Q=t=>{I.value=t,A.value=!0},se=async t=>{t.status="in-progress",t.startedAt=new Date().toISOString(),t.progress=t.progress||10,await H.updateTask(String(t.projectId),String(t.id),{status:"in-progress",progress:t.progress,startedAt:t.startedAt}),T.success("任务已开始"),f()},n=t=>{I.value=t,u.value=!0},s=t=>{I.value=t,C.value=!0},_=t=>{n(t)},p=t=>{s(t)},j=async t=>{const e=l.value.find(v=>v.id===t.id);e&&(e.status="completed",e.progress=100,e.completedAt=new Date().toISOString(),await H.updateTask(String(e.projectId),String(e.id),{status:"completed",progress:100,completedAt:e.completedAt}),T.success("任务已完成"),f())},pe=async t=>{const e=l.value.find(v=>v.id===I.value.id);if(e){const v=e.progress||0,$=e.status;e.progress=t.progress,e.note=t.note,e.estimatedCompletion=t.estimatedCompletion,t.progress===100&&(e.status="completed",e.completedAt=new Date().toISOString());const O={id:Date.now(),type:"progress_update",timestamp:new Date().toISOString(),user:U(),userId:"user_001",data:{oldProgress:v,newProgress:t.progress,note:t.note,estimatedCompletion:t.estimatedCompletion,statusChange:$!==e.status?{from:$,to:e.status}:null},comments:[]};e.operationHistory||(e.operationHistory=[]),e.operationHistory.push(O),await H.updateTask(String(e.projectId),String(e.id),{progress:e.progress,status:e.status,completedAt:e.completedAt,note:e.note,estimatedCompletion:e.estimatedCompletion,operationHistory:e.operationHistory}),T.success("进度更新成功"),f()}u.value=!1},E=async t=>{const e=l.value.find(v=>v.id===I.value.id);if(e){e.submittedMaterials=t.materials,e.submissionNote=t.note,e.submittedAt=new Date().toISOString();const v={id:Date.now(),type:"material_submission",timestamp:new Date().toISOString(),user:U(),userId:"user_001",data:{materials:t.materials,note:t.note,submissionCount:t.materials.length},comments:[]};e.operationHistory||(e.operationHistory=[]),e.operationHistory.push(v),await H.updateTask(String(e.projectId),String(e.id),{submittedMaterials:e.submittedMaterials,submissionNote:e.submissionNote,submittedAt:e.submittedAt,operationHistory:e.operationHistory}),T.success("材料提交成功"),f()}C.value=!1},de=()=>{T.success("任务列表已刷新")},me=t=>t.milestoneType&&t.status==="in-progress"&&t.progress>=80,le=t=>{const e=new Date,v=new Date(t),$=Math.ceil((v-e)/(1e3*60*60*24));return $<=3&&$>=0},G=t=>new Date(t).toLocaleDateString("zh-CN"),ue=t=>t?new Date(t).toLocaleDateString("zh-CN"):"-",h=t=>({high:"red",medium:"orange",low:"blue"})[t]||"default",P=t=>({high:"高优先级",medium:"中优先级",low:"低优先级"})[t]||t,Y=t=>({pending:"待办","in-progress":"进行中",completed:"已完成"})[t]||t,X=t=>({opening:"开题",midterm:"中期",acceptance:"验收"})[t]||t;qe(()=>{const t=x();t&&(l.value=t),de();const e=v=>{try{const{projectId:$,taskKey:O,updates:ve}=v.detail||{};if(!$||!O||!ve)return;const re=l.value.find(ne=>String(ne.projectId)===String($)&&String(ne.id)===String(O));if(!re)return;["status","progress","completedAt","startedAt","note","estimatedCompletion","submittedMaterials","submissionNote","submittedAt","operationHistory"].forEach(ne=>{ve[ne]!==void 0&&(re[ne]=ve[ne])}),f()}catch($){console.warn("同步外部任务更新失败:",$)}};window.addEventListener("taskDataUpdated",e),ce.value=e,_e()}),fe(l,()=>{f()},{deep:!0});const ce=S(null);Ue(()=>{ce.value&&window.removeEventListener("taskDataUpdated",ce.value)});function _e(){try{let t=!1;l.value.forEach(e=>{const v=H.getTask(String(e.projectId),String(e.id));v&&["status","progress","completedAt","startedAt","note","estimatedCompletion","submittedMaterials","submissionNote","submittedAt","operationHistory"].forEach(O=>{v[O]!==void 0&&e[O]!==v[O]&&(e[O]=v[O],t=!0)})}),t&&f()}catch(t){console.warn("合并缓存失败:",t)}}return(t,e)=>{const v=g("a-statistic"),$=g("a-alert"),O=g("a-select-option"),ve=g("a-select"),re=g("a-button"),oe=g("a-tag"),ne=g("a-space"),ke=g("a-badge"),$e=g("a-progress");return m(),b("div",Et,[o("div",Ft,[e[13]||(e[13]=o("h1",null,"📋 我的任务看板",-1)),o("div",Rt,[i(v,{title:"待办",value:w.value.pending},null,8,["value"]),i(v,{title:"进行中",value:w.value.inProgress},null,8,["value"]),i(v,{title:"已完成",value:w.value.completed},null,8,["value"]),i(v,{title:"完成率",value:z.value,suffix:"%"},null,8,["value"])])]),o("div",Lt,[i($,{type:"info","show-icon":"",closable:"",style:{"margin-bottom":"16px"}},{message:a(()=>e[14]||(e[14]=[o("strong",null,"🔄 实时同步机制",-1)])),description:a(()=>e[15]||(e[15]=[o("div",{class:"sync-description"},[d(" 此任务看板与项目经理监控页面"),o("strong",null,"实时双向同步"),d("： "),o("br"),d("• 您的任务来源于项目经理在监控页面的WBS分配 "),o("br"),d("• 您的进度更新、状态变更、材料提交会立即反映到项目经理的甘特图 "),o("br"),d("• 支持拖拽切换状态，点击查看详情或快速操作 "),o("br"),d("• 系统根据您的登录账号只显示分配给您的任务 ")],-1)])),_:1}),o("div",Vt,[i(ne,null,{default:a(()=>[i(ve,{value:k.value,"onUpdate:value":e[0]||(e[0]=r=>k.value=r),placeholder:"筛选项目",style:{width:"200px"},"allow-clear":""},{default:a(()=>[(m(!0),b(ie,null,ae(V.value,r=>(m(),q(O,{key:r.id,value:r.id},{default:a(()=>[d(c(r.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"]),i(re,{onClick:de},{default:a(()=>[i(B(Oe)),e[16]||(e[16]=d(" 刷新 "))]),_:1,__:[16]}),i(oe,{color:"blue"},{default:a(()=>[d(" 🆔 当前用户: "+c(U()),1)]),_:1})]),_:1})])]),o("div",Wt,[o("div",Yt,[o("div",Kt,[e[17]||(e[17]=o("h3",null,"🕐 待办",-1)),i(ke,{count:w.value.pending,color:"#faad14"},null,8,["count"])]),o("div",{class:"column-content",onDrop:e[1]||(e[1]=r=>W(r,"pending")),onDragover:e[2]||(e[2]=Z(()=>{},["prevent"])),onDragenter:e[3]||(e[3]=Z(()=>{},["prevent"]))},[(m(!0),b(ie,null,ae(te.value,r=>(m(),b("div",{key:r.id,class:"task-card pending-card",draggable:"true",onDragstart:L=>J(L,r),onClick:L=>Q(r)},[o("div",Qt,[o("h4",Gt,c(r.title),1),o("div",Xt,[i(oe,{color:h(r.priority),size:"small"},{default:a(()=>[d(c(P(r.priority)),1)]),_:2},1032,["color"]),r.milestoneType?(m(),q(oe,{key:0,color:"gold",size:"small"},{default:a(()=>[d(c(X(r.milestoneType)),1)]),_:2},1024)):N("",!0)])]),o("div",Zt,[o("div",es,c(r.description||"暂无描述"),1),o("div",ts,[i(B(ge)),o("span",{class:he({"deadline-warning":le(r.deadline)})},c(G(r.deadline)),3)]),o("div",ss,[i(B(be)),o("span",null,c(r.projectName),1)]),o("div",os," 👤 分配人: "+c(r.assignedBy),1)]),o("div",ns,[i(re,{type:"primary",size:"small",onClick:Z(L=>se(r),["stop"])},{default:a(()=>e[18]||(e[18]=[d(" 开始任务 ")])),_:2,__:[18]},1032,["onClick"])])],40,Jt))),128)),te.value.length===0?(m(),b("div",is," 暂无待办任务 ")):N("",!0)],32)]),o("div",as,[o("div",ls,[e[19]||(e[19]=o("h3",null,"🚀 进行中",-1)),i(ke,{count:w.value.inProgress,color:"#1890ff"},null,8,["count"])]),o("div",{class:"column-content",onDrop:e[4]||(e[4]=r=>W(r,"in-progress")),onDragover:e[5]||(e[5]=Z(()=>{},["prevent"])),onDragenter:e[6]||(e[6]=Z(()=>{},["prevent"]))},[(m(!0),b(ie,null,ae(M.value,r=>(m(),b("div",{key:r.id,class:"task-card inprogress-card",draggable:"true",onDragstart:L=>J(L,r),onClick:L=>Q(r)},[o("div",ds,[o("h4",us,c(r.title),1),o("div",cs,[i(oe,{color:h(r.priority),size:"small"},{default:a(()=>[d(c(P(r.priority)),1)]),_:2},1032,["color"]),r.milestoneType?(m(),q(oe,{key:0,color:"gold",size:"small"},{default:a(()=>[d(c(X(r.milestoneType)),1)]),_:2},1024)):N("",!0)])]),o("div",ps,[o("div",ms,c(r.description||"暂无描述"),1),o("div",vs,[i($e,{percent:r.progress||0,size:"small",status:"active"},null,8,["percent"])]),o("div",gs,[i(B(ge)),o("span",{class:he({"deadline-warning":le(r.deadline)})},c(G(r.deadline)),3)]),o("div",_s,[i(B(be)),o("span",null,c(r.projectName),1)]),o("div",fs," 👤 分配人: "+c(r.assignedBy),1)]),o("div",ys,[i(re,{size:"small",onClick:Z(L=>n(r),["stop"])},{default:a(()=>e[20]||(e[20]=[d(" 更新进度 ")])),_:2,__:[20]},1032,["onClick"]),me(r)?(m(),q(re,{key:0,type:"primary",size:"small",onClick:Z(L=>s(r),["stop"])},{default:a(()=>e[21]||(e[21]=[d(" 提交材料 ")])),_:2,__:[21]},1032,["onClick"])):N("",!0)])],40,rs))),128)),M.value.length===0?(m(),b("div",ks," 暂无进行中任务 ")):N("",!0)],32)]),o("div",bs,[o("div",hs,[e[22]||(e[22]=o("h3",null,"✅ 已完成",-1)),i(ke,{count:w.value.completed,color:"#52c41a"},null,8,["count"])]),o("div",{class:"column-content",onDrop:e[7]||(e[7]=r=>W(r,"completed")),onDragover:e[8]||(e[8]=Z(()=>{},["prevent"])),onDragenter:e[9]||(e[9]=Z(()=>{},["prevent"]))},[(m(!0),b(ie,null,ae(K.value,r=>(m(),b("div",{key:r.id,class:"task-card completed-card",draggable:"true",onDragstart:L=>J(L,r),onClick:L=>Q(r)},[o("div",$s,[o("h4",Cs,c(r.title),1),o("div",Ds,[i(oe,{color:"#52c41a",size:"small"},{default:a(()=>e[23]||(e[23]=[d("已完成")])),_:1,__:[23]}),r.milestoneType?(m(),q(oe,{key:0,color:"gold",size:"small"},{default:a(()=>[d(c(X(r.milestoneType)),1)]),_:2},1024)):N("",!0)])]),o("div",Ss,[o("div",Ts,c(r.description||"暂无描述"),1),o("div",xs,[i($e,{percent:100,size:"small",status:"success"})]),o("div",Is,[i(B(Me)),o("span",null,"完成于: "+c(ue(r.completedAt)),1)]),o("div",As,[i(B(be)),o("span",null,c(r.projectName),1)]),o("div",js," 👤 分配人: "+c(r.assignedBy),1)])],40,ws))),128)),K.value.length===0?(m(),b("div",qs," 暂无已完成任务 ")):N("",!0)],32)])]),i(pt,{visible:A.value,"onUpdate:visible":e[10]||(e[10]=r=>A.value=r),task:I.value,onUpdateProgress:_,onSubmitMaterial:p,onTaskCompleted:j},null,8,["visible","task"]),i(ft,{visible:u.value,"onUpdate:visible":e[11]||(e[11]=r=>u.value=r),task:I.value,onConfirm:pe},null,8,["visible","task"]),i(zt,{visible:C.value,"onUpdate:visible":e[12]||(e[12]=r=>C.value=r),task:I.value,onConfirm:E},null,8,["visible","task"])])}}},Bs=ye(Us,[["__scopeId","data-v-7bce43d5"]]);export{Bs as default};
