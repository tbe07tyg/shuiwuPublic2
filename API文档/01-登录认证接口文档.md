# ğŸ” ç™»å½•è®¤è¯æ¥å£æ–‡æ¡£

## ğŸ“‹ æ–‡æ¡£ä¿¡æ¯

- **æ¨¡å—åç§°**: ç™»å½•è®¤è¯æ¨¡å—
- **åˆ›å»ºæ—¶é—´**: 2025-01-17
- **ç‰ˆæœ¬**: v1.0
- **æ¡†æ¶**: RuoYi-Vue
- **åç«¯è¯­è¨€**: Java + Spring Boot
- **å‰ç«¯å¯¹åº”**: 01-ç™»å½•é¡µé¢è®¾è®¡æ–‡æ¡£

## ğŸ¯ æ¥å£æ¦‚è§ˆ

| åºå· | æ¥å£åç§° | è¯·æ±‚æ–¹å¼ | æ¥å£åœ°å€ | è¯´æ˜ |
|------|----------|----------|----------|------|
| 1 | è´¦å·å¯†ç ç™»å½• | POST | `/auth/login` | ç”¨æˆ·åå¯†ç ç™»å½• |
| 2 | æ‰‹æœºéªŒè¯ç ç™»å½• | POST | `/auth/smsLogin` | æ‰‹æœºå·éªŒè¯ç ç™»å½• |
| 3 | å‘é€éªŒè¯ç  | POST | `/auth/sendSms` | å‘é€æ‰‹æœºéªŒè¯ç  |
| 4 | é€€å‡ºç™»å½• | POST | `/auth/logout` | ç”¨æˆ·é€€å‡ºç™»å½• |
| 5 | åˆ·æ–°Token | POST | `/auth/refresh` | åˆ·æ–°è®¿é—®ä»¤ç‰Œ |
| 6 | è·å–ç”¨æˆ·ä¿¡æ¯ | GET | `/auth/getInfo` | è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ |
| 7 | ä¿®æ”¹å¯†ç  | PUT | `/auth/changePassword` | é¦–æ¬¡ç™»å½•ä¿®æ”¹å¯†ç  |
| 8 | è·å–ç™»å½•å†å² | GET | `/auth/loginHistory` | è·å–ç”¨æˆ·ç™»å½•å†å²è®°å½• |

## ğŸ”‘ 1. è´¦å·å¯†ç ç™»å½•

### æ¥å£ä¿¡æ¯
- **æ¥å£åœ°å€**: `/auth/login`
- **è¯·æ±‚æ–¹å¼**: POST
- **æ¥å£æè¿°**: ç”¨æˆ·ä½¿ç”¨ç”¨æˆ·åå’Œå¯†ç è¿›è¡Œç™»å½•è®¤è¯

### è¯·æ±‚å‚æ•°

```json
{
  "username": "admin",
  "password": "admin123",
  "code": "1234",
  "uuid": "verification_uuid"
}
```

| å‚æ•°å | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|--------|------|------|------|
| username | String | æ˜¯ | ç”¨æˆ·å/å·¥å· |
| password | String | æ˜¯ | å¯†ç (MD5åŠ å¯†) |
| code | String | å¦ | å›¾å½¢éªŒè¯ç  |
| uuid | String | å¦ | éªŒè¯ç UUID |

### å“åº”å‚æ•°

**æˆåŠŸå“åº”**:
```json
{
  "code": 200,
  "msg": "æ“ä½œæˆåŠŸ",
  "data": {
    "token": "eyJhbGciOiJIUzUxMiJ9...",
    "user": {
      "userId": 1,
      "username": "admin",
      "nickName": "ç®¡ç†å‘˜",
      "email": "admin@example.com",
      "phonenumber": "13800138000",
      "sex": "1",
      "avatar": "",
      "deptId": 103,
      "deptName": "ç ”å‘éƒ¨é—¨",
      "roleIds": [1],
      "roles": ["admin"],
      "permissions": ["*:*:*"],
      "isFirstLogin": false,
      "lastLoginTime": "2025-01-17 10:30:00",
      "lastLoginIp": "192.168.1.100"
    }
  }
}
```

**å¤±è´¥å“åº”**:
```json
{
  "code": 500,
  "msg": "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯",
  "data": null
}
```

### Java Controllerå®ç°

```java
@RestController
@RequestMapping("/auth")
@Api(tags = "ç™»å½•è®¤è¯æ¥å£")
public class SysLoginController extends BaseController {
    
    @Autowired
    private SysLoginService loginService;
    
    @Autowired
    private ISysUserService userService;
    
    /**
     * ç™»å½•æ–¹æ³•
     */
    @PostMapping("/login")
    @ApiOperation("ç”¨æˆ·ç™»å½•")
    public AjaxResult login(@RequestBody LoginBody loginBody) {
        AjaxResult ajax = AjaxResult.success();
        // ç”Ÿæˆä»¤ç‰Œ
        String token = loginService.login(loginBody.getUsername(), 
                                         loginBody.getPassword(), 
                                         loginBody.getCode(), 
                                         loginBody.getUuid());
        ajax.put(Constants.TOKEN, token);
        
        // è·å–ç”¨æˆ·ä¿¡æ¯
        LoginUser loginUser = tokenService.getLoginUser(ServletUtils.getRequest());
        SysUser user = loginUser.getUser();
        ajax.put("user", user);
        
        return ajax;
    }
}
```

### ä¸šåŠ¡é€»è¾‘å®ç°

```java
@Service
public class SysLoginService {
    
    @Autowired
    private TokenService tokenService;
    
    @Autowired
    private AuthenticationManager authenticationManager;
    
    @Autowired
    private RedisCache redisCache;
    
    /**
     * ç™»å½•éªŒè¯
     */
    public String login(String username, String password, String code, String uuid) {
        // éªŒè¯ç æ ¡éªŒ
        validateCaptcha(username, code, uuid);
        
        // ç™»å½•å‰ç½®æ ¡éªŒ
        loginPreCheck(username, password);
        
        // ç”¨æˆ·éªŒè¯
        Authentication authentication = null;
        try {
            UsernamePasswordAuthenticationToken authenticationToken = 
                new UsernamePasswordAuthenticationToken(username, password);
            AuthContextHolder.setContext(authenticationToken);
            // è¯¥æ–¹æ³•ä¼šå»è°ƒç”¨UserDetailsServiceImpl.loadUserByUsername
            authentication = authenticationManager.authenticate(authenticationToken);
        } catch (Exception e) {
            if (e instanceof BadCredentialsException) {
                AsyncManager.me().execute(AsyncFactory.recordLogininfor(
                    username, Constants.LOGIN_FAIL, MessageUtils.message("user.password.not.match")));
                throw new UserPasswordNotMatchException();
            } else {
                AsyncManager.me().execute(AsyncFactory.recordLogininfor(
                    username, Constants.LOGIN_FAIL, e.getMessage()));
                throw new ServiceException(e.getMessage());
            }
        } finally {
            AuthContextHolder.clearContext();
        }
        
        AsyncManager.me().execute(AsyncFactory.recordLogininfor(
            username, Constants.LOGIN_SUCCESS, MessageUtils.message("user.login.success")));
        
        LoginUser loginUser = (LoginUser) authentication.getPrincipal();
        recordLoginInfo(loginUser.getUserId());
        
        // ç”Ÿæˆtoken
        return tokenService.createToken(loginUser);
    }
    
    /**
     * æ ¡éªŒéªŒè¯ç 
     */
    public void validateCaptcha(String username, String code, String uuid) {
        String verifyKey = CacheConstants.CAPTCHA_CODE_KEY + StringUtils.nvl(uuid, "");
        String captcha = redisCache.getCacheObject(verifyKey);
        redisCache.deleteObject(verifyKey);
        
        if (captcha == null) {
            AsyncManager.me().execute(AsyncFactory.recordLogininfor(
                username, Constants.LOGIN_FAIL, MessageUtils.message("user.jcaptcha.expire")));
            throw new CaptchaExpireException();
        }
        
        if (!code.equalsIgnoreCase(captcha)) {
            AsyncManager.me().execute(AsyncFactory.recordLogininfor(
                username, Constants.LOGIN_FAIL, MessageUtils.message("user.jcaptcha.error")));
            throw new CaptchaException();
        }
    }
}
```

## ğŸ“± 2. æ‰‹æœºéªŒè¯ç ç™»å½•

### æ¥å£ä¿¡æ¯
- **æ¥å£åœ°å€**: `/auth/smsLogin`
- **è¯·æ±‚æ–¹å¼**: POST
- **æ¥å£æè¿°**: ç”¨æˆ·ä½¿ç”¨æ‰‹æœºå·å’ŒéªŒè¯ç è¿›è¡Œç™»å½•

### è¯·æ±‚å‚æ•°

```json
{
  "phone": "13800138000",
  "code": "123456"
}
```

| å‚æ•°å | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|--------|------|------|------|
| phone | String | æ˜¯ | æ‰‹æœºå·ç (11ä½) |
| code | String | æ˜¯ | çŸ­ä¿¡éªŒè¯ç (6ä½) |

### å“åº”å‚æ•°

**æˆåŠŸå“åº”**: åŒè´¦å·å¯†ç ç™»å½•
**å¤±è´¥å“åº”**: 
```json
{
  "code": 500,
  "msg": "éªŒè¯ç é”™è¯¯æˆ–å·²è¿‡æœŸ",
  "data": null
}
```

### Javaå®ç°

```java
/**
 * æ‰‹æœºéªŒè¯ç ç™»å½•
 */
@PostMapping("/smsLogin")
@ApiOperation("æ‰‹æœºéªŒè¯ç ç™»å½•")
public AjaxResult smsLogin(@RequestBody SmsLoginBody smsLoginBody) {
    AjaxResult ajax = AjaxResult.success();
    
    // éªŒè¯ç æ ¡éªŒ
    String verifyKey = CacheConstants.SMS_CODE_KEY + smsLoginBody.getPhone();
    String smsCode = redisCache.getCacheObject(verifyKey);
    
    if (StringUtils.isEmpty(smsCode)) {
        return error("éªŒè¯ç å·²è¿‡æœŸï¼Œè¯·é‡æ–°è·å–");
    }
    
    if (!smsLoginBody.getCode().equals(smsCode)) {
        return error("éªŒè¯ç é”™è¯¯");
    }
    
    // æ ¹æ®æ‰‹æœºå·æŸ¥æ‰¾ç”¨æˆ·
    SysUser user = userService.selectUserByPhonenumber(smsLoginBody.getPhone());
    if (StringUtils.isNull(user)) {
        return error("è¯¥æ‰‹æœºå·æœªç»‘å®šç”¨æˆ·");
    }
    
    // ç”Ÿæˆtoken
    LoginUser loginUser = new LoginUser(user.getUserId(), user.getDeptId(), user, null);
    String token = tokenService.createToken(loginUser);
    
    ajax.put(Constants.TOKEN, token);
    ajax.put("user", user);
    
    // åˆ é™¤éªŒè¯ç 
    redisCache.deleteObject(verifyKey);
    
    // è®°å½•ç™»å½•æ—¥å¿—
    AsyncManager.me().execute(AsyncFactory.recordLogininfor(
        user.getUserName(), Constants.LOGIN_SUCCESS, "æ‰‹æœºéªŒè¯ç ç™»å½•æˆåŠŸ"));
    
    return ajax;
}
```

## ğŸ“¨ 3. å‘é€éªŒè¯ç 

### æ¥å£ä¿¡æ¯
- **æ¥å£åœ°å€**: `/auth/sendSms`
- **è¯·æ±‚æ–¹å¼**: POST
- **æ¥å£æè¿°**: å‘æŒ‡å®šæ‰‹æœºå·å‘é€ç™»å½•éªŒè¯ç 

### è¯·æ±‚å‚æ•°

```json
{
  "phone": "13800138000"
}
```

| å‚æ•°å | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|--------|------|------|------|
| phone | String | æ˜¯ | æ‰‹æœºå·ç (11ä½) |

### å“åº”å‚æ•°

```json
{
  "code": 200,
  "msg": "éªŒè¯ç å‘é€æˆåŠŸ",
  "data": {
    "countdown": 60
  }
}
```

### Javaå®ç°

```java
/**
 * å‘é€çŸ­ä¿¡éªŒè¯ç 
 */
@PostMapping("/sendSms")
@ApiOperation("å‘é€çŸ­ä¿¡éªŒè¯ç ")
public AjaxResult sendSms(@RequestBody Map<String, String> params) {
    String phone = params.get("phone");
    
    // æ‰‹æœºå·æ ¼å¼éªŒè¯
    if (!RegexUtils.isPhoneNumber(phone)) {
        return error("æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®");
    }
    
    // æ£€æŸ¥å‘é€é¢‘ç‡é™åˆ¶
    String rateKey = CacheConstants.SMS_RATE_KEY + phone;
    String lastSendTime = redisCache.getCacheObject(rateKey);
    if (StringUtils.isNotEmpty(lastSendTime)) {
        return error("éªŒè¯ç å‘é€è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•");
    }
    
    // ç”Ÿæˆ6ä½æ•°å­—éªŒè¯ç 
    String code = RandomUtil.randomNumbers(6);
    
    // å‘é€çŸ­ä¿¡
    try {
        boolean success = smsService.sendLoginCode(phone, code);
        if (!success) {
            return error("éªŒè¯ç å‘é€å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•");
        }
        
        // ç¼“å­˜éªŒè¯ç ï¼Œ5åˆ†é’Ÿæœ‰æ•ˆ
        redisCache.setCacheObject(CacheConstants.SMS_CODE_KEY + phone, code, 5, TimeUnit.MINUTES);
        
        // è®¾ç½®å‘é€é¢‘ç‡é™åˆ¶ï¼Œ60ç§’å†…ä¸å¯é‡å¤å‘é€
        redisCache.setCacheObject(rateKey, String.valueOf(System.currentTimeMillis()), 60, TimeUnit.SECONDS);
        
        return success("éªŒè¯ç å‘é€æˆåŠŸ").put("countdown", 60);
        
    } catch (Exception e) {
        log.error("å‘é€çŸ­ä¿¡éªŒè¯ç å¼‚å¸¸", e);
        return error("éªŒè¯ç å‘é€å¤±è´¥");
    }
}

@Service
public class SmsServiceImpl implements SmsService {
    
    /**
     * å‘é€ç™»å½•éªŒè¯ç 
     */
    @Override
    public boolean sendLoginCode(String phone, String code) {
        try {
            // è¿™é‡Œæ¥å…¥å…·ä½“çš„çŸ­ä¿¡æœåŠ¡å•†API
            // å¦‚é˜¿é‡Œäº‘çŸ­ä¿¡ã€è…¾è®¯äº‘çŸ­ä¿¡ç­‰
            String templateCode = "SMS_LOGIN_CODE";
            String templateParam = "{\"code\":\"" + code + "\"}";
            
            // è°ƒç”¨çŸ­ä¿¡æœåŠ¡
            return aliSmsClient.sendSms(phone, templateCode, templateParam);
            
        } catch (Exception e) {
            log.error("å‘é€çŸ­ä¿¡éªŒè¯ç å¤±è´¥ï¼šphone={}, code={}", phone, code, e);
            return false;
        }
    }
}
```

## ğŸšª 4. é€€å‡ºç™»å½•

### æ¥å£ä¿¡æ¯
- **æ¥å£åœ°å€**: `/auth/logout`
- **è¯·æ±‚æ–¹å¼**: POST
- **æ¥å£æè¿°**: ç”¨æˆ·é€€å‡ºç™»å½•ï¼Œæ¸…é™¤token

### è¯·æ±‚å‚æ•°

```json
{}
```

### å“åº”å‚æ•°

```json
{
  "code": 200,
  "msg": "é€€å‡ºæˆåŠŸ",
  "data": null
}
```

### Javaå®ç°

```java
/**
 * é€€å‡ºç™»å½•
 */
@PostMapping("/logout")
@ApiOperation("é€€å‡ºç™»å½•")
public AjaxResult logout() {
    LoginUser loginUser = tokenService.getLoginUser(ServletUtils.getRequest());
    if (StringUtils.isNotNull(loginUser)) {
        String userName = loginUser.getUsername();
        // åˆ é™¤ç”¨æˆ·ç¼“å­˜è®°å½•
        tokenService.delLoginUser(loginUser.getToken());
        // è®°å½•ç”¨æˆ·é€€å‡ºæ—¥å¿—
        AsyncManager.me().execute(AsyncFactory.recordLogininfor(
            userName, Constants.LOGOUT, "é€€å‡ºæˆåŠŸ"));
    }
    return success("é€€å‡ºæˆåŠŸ");
}
```

## ğŸ”„ 5. åˆ·æ–°Token

### æ¥å£ä¿¡æ¯
- **æ¥å£åœ°å€**: `/auth/refresh`
- **è¯·æ±‚æ–¹å¼**: POST
- **æ¥å£æè¿°**: åˆ·æ–°è®¿é—®ä»¤ç‰Œï¼Œå»¶é•¿ç™»å½•æœ‰æ•ˆæœŸ

### è¯·æ±‚å‚æ•°
```json
{}
```

### å“åº”å‚æ•°
```json
{
  "code": 200,
  "msg": "åˆ·æ–°æˆåŠŸ",
  "data": {
    "token": "new_token_value"
  }
}
```

### Javaå®ç°

```java
/**
 * åˆ·æ–°ä»¤ç‰Œ
 */
@PostMapping("/refresh")
@ApiOperation("åˆ·æ–°ä»¤ç‰Œ")
public AjaxResult refresh(HttpServletRequest request) {
    LoginUser loginUser = tokenService.getLoginUser(request);
    if (StringUtils.isNotNull(loginUser)) {
        // åˆ·æ–°ä»¤ç‰Œæœ‰æ•ˆæœŸ
        tokenService.refreshToken(loginUser);
        return success().put("token", loginUser.getToken());
    }
    return error("ä»¤ç‰Œå·²è¿‡æœŸ");
}
```

## ğŸ‘¤ 6. è·å–ç”¨æˆ·ä¿¡æ¯

### æ¥å£ä¿¡æ¯
- **æ¥å£åœ°å€**: `/auth/getInfo`
- **è¯·æ±‚æ–¹å¼**: GET
- **æ¥å£æè¿°**: è·å–å½“å‰ç™»å½•ç”¨æˆ·çš„è¯¦ç»†ä¿¡æ¯

### è¯·æ±‚å‚æ•°
æ— éœ€è¯·æ±‚å‚æ•°ï¼Œä»tokenä¸­è·å–ç”¨æˆ·ä¿¡æ¯

### å“åº”å‚æ•°

```json
{
  "code": 200,
  "msg": "æ“ä½œæˆåŠŸ",
  "data": {
    "user": {
      "userId": 1,
      "username": "admin",
      "nickName": "ç®¡ç†å‘˜",
      "email": "admin@example.com",
      "phonenumber": "13800138000",
      "sex": "1",
      "avatar": "",
      "deptId": 103,
      "deptName": "ç ”å‘éƒ¨é—¨"
    },
    "roles": ["admin", "common"],
    "permissions": ["*:*:*"]
  }
}
```

### Javaå®ç°

```java
/**
 * è·å–ç”¨æˆ·ä¿¡æ¯
 */
@GetMapping("/getInfo")
@ApiOperation("è·å–ç”¨æˆ·ä¿¡æ¯")
public AjaxResult getInfo() {
    SysUser user = SecurityUtils.getLoginUser().getUser();
    // è§’è‰²é›†åˆ
    Set<String> roles = permissionService.getRolePermission(user);
    // æƒé™é›†åˆ
    Set<String> permissions = permissionService.getMenuPermission(user);
    
    AjaxResult ajax = AjaxResult.success();
    ajax.put("user", user);
    ajax.put("roles", roles);
    ajax.put("permissions", permissions);
    return ajax;
}
```

## ğŸ” 7. ä¿®æ”¹å¯†ç 

### æ¥å£ä¿¡æ¯
- **æ¥å£åœ°å€**: `/auth/changePassword`
- **è¯·æ±‚æ–¹å¼**: PUT
- **æ¥å£æè¿°**: é¦–æ¬¡ç™»å½•æˆ–ç”¨æˆ·ä¸»åŠ¨ä¿®æ”¹å¯†ç 

### è¯·æ±‚å‚æ•°

```json
{
  "oldPassword": "admin123",
  "newPassword": "newpassword123",
  "confirmPassword": "newpassword123"
}
```

| å‚æ•°å | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|--------|------|------|------|
| oldPassword | String | å¦ | åŸå¯†ç (é¦–æ¬¡ç™»å½•å¯ä¸ºç©º) |
| newPassword | String | æ˜¯ | æ–°å¯†ç  |
| confirmPassword | String | æ˜¯ | ç¡®è®¤å¯†ç  |

### å“åº”å‚æ•°

```json
{
  "code": 200,
  "msg": "å¯†ç ä¿®æ”¹æˆåŠŸ",
  "data": null
}
```

### Javaå®ç°

```java
/**
 * ä¿®æ”¹å¯†ç 
 */
@PutMapping("/changePassword")
@ApiOperation("ä¿®æ”¹å¯†ç ")
public AjaxResult changePassword(@RequestBody ChangePasswordBody body) {
    LoginUser loginUser = SecurityUtils.getLoginUser();
    SysUser user = loginUser.getUser();
    
    String userName = user.getUserName();
    String password = user.getPassword();
    
    // éé¦–æ¬¡ç™»å½•éœ€è¦éªŒè¯åŸå¯†ç 
    if (!user.getIsFirstLogin() && StringUtils.isNotEmpty(body.getOldPassword())) {
        if (!SecurityUtils.matchesPassword(body.getOldPassword(), password)) {
            return error("ä¿®æ”¹å¯†ç å¤±è´¥ï¼Œæ—§å¯†ç é”™è¯¯");
        }
    }
    
    // éªŒè¯æ–°å¯†ç 
    if (!body.getNewPassword().equals(body.getConfirmPassword())) {
        return error("æ–°å¯†ç å’Œç¡®è®¤å¯†ç ä¸ä¸€è‡´");
    }
    
    // å¯†ç å¼ºåº¦æ ¡éªŒ
    if (!isValidPassword(body.getNewPassword())) {
        return error("å¯†ç å¼ºåº¦ä¸å¤Ÿï¼Œè¯·ä½¿ç”¨8-20ä½å­—æ¯æ•°å­—ç»„åˆ");
    }
    
    // æ›´æ–°å¯†ç 
    if (userService.resetUserPwd(userName, SecurityUtils.encryptPassword(body.getNewPassword())) > 0) {
        // æ›´æ–°é¦–æ¬¡ç™»å½•æ ‡è¯†
        if (user.getIsFirstLogin()) {
            user.setIsFirstLogin(false);
            userService.updateUser(user);
        }
        
        // è®°å½•æ“ä½œæ—¥å¿—
        AsyncManager.me().execute(AsyncFactory.recordLogininfor(
            userName, Constants.LOGIN_SUCCESS, "å¯†ç ä¿®æ”¹æˆåŠŸ"));
        
        return success("å¯†ç ä¿®æ”¹æˆåŠŸ");
    }
    return error("å¯†ç ä¿®æ”¹å¤±è´¥ï¼Œè¯·è”ç³»ç®¡ç†å‘˜");
}

/**
 * å¯†ç å¼ºåº¦æ ¡éªŒ
 */
private boolean isValidPassword(String password) {
    if (StringUtils.isEmpty(password) || password.length() < 8 || password.length() > 20) {
        return false;
    }
    
    // è‡³å°‘åŒ…å«å­—æ¯å’Œæ•°å­—
    boolean hasLetter = password.matches(".*[a-zA-Z].*");
    boolean hasDigit = password.matches(".*\\d.*");
    
    return hasLetter && hasDigit;
}
```

## ğŸ“‹ 8. è·å–ç™»å½•å†å²

### æ¥å£ä¿¡æ¯
- **æ¥å£åœ°å€**: `/auth/loginHistory`
- **è¯·æ±‚æ–¹å¼**: GET
- **æ¥å£æè¿°**: è·å–ç”¨æˆ·æœ€è¿‘çš„ç™»å½•å†å²è®°å½•

### è¯·æ±‚å‚æ•°

| å‚æ•°å | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|--------|------|------|------|
| pageNum | Integer | å¦ | é¡µç ï¼Œé»˜è®¤1 |
| pageSize | Integer | å¦ | æ¯é¡µæ•°é‡ï¼Œé»˜è®¤10 |

### å“åº”å‚æ•°

```json
{
  "code": 200,
  "msg": "æŸ¥è¯¢æˆåŠŸ",
  "data": {
    "total": 25,
    "rows": [
      {
        "infoId": 1,
        "userName": "admin",
        "ipaddr": "192.168.1.100",
        "loginLocation": "å†…ç½‘IP",
        "browser": "Chrome 120",
        "os": "Windows 10",
        "status": "0",
        "msg": "ç™»å½•æˆåŠŸ",
        "loginTime": "2025-01-17 10:30:00",
        "isAbnormal": false
      }
    ]
  }
}
```

### Javaå®ç°

```java
/**
 * è·å–ç™»å½•å†å²
 */
@GetMapping("/loginHistory")
@ApiOperation("è·å–ç™»å½•å†å²")
public TableDataInfo loginHistory(SysLogininfor logininfor) {
    SysUser currentUser = SecurityUtils.getLoginUser().getUser();
    logininfor.setUserName(currentUser.getUserName());
    
    startPage();
    List<SysLogininfor> list = logininforService.selectLogininforList(logininfor);
    
    // æ ‡è®°å¼‚å¸¸IP
    for (SysLogininfor log : list) {
        log.setAbnormal(isAbnormalIp(log.getIpaddr(), currentUser.getUserName()));
    }
    
    return getDataTable(list);
}

/**
 * åˆ¤æ–­æ˜¯å¦ä¸ºå¼‚å¸¸IP
 */
private boolean isAbnormalIp(String ipaddr, String userName) {
    // è·å–ç”¨æˆ·å¸¸ç”¨IPåˆ—è¡¨
    List<String> commonIps = userService.getCommonIps(userName);
    
    // æ£€æŸ¥æ˜¯å¦ä¸ºå¸¸ç”¨IP
    if (!commonIps.contains(ipaddr)) {
        // æ£€æŸ¥IPåœ°ç†ä½ç½®æ˜¯å¦å¼‚å¸¸
        String location = IpUtils.getRealAddressByIP(ipaddr);
        return isAbnormalLocation(location, userName);
    }
    
    return false;
}
```

## ğŸ›¡ï¸ å®‰å…¨é…ç½®

### Tokené…ç½®

```java
@Component
public class TokenService {
    
    // ä»¤ç‰Œè‡ªå®šä¹‰æ ‡è¯†
    @Value("${token.header}")
    private String header;
    
    // ä»¤ç‰Œç§˜é’¥
    @Value("${token.secret}")
    private String secret;
    
    // ä»¤ç‰Œæœ‰æ•ˆæœŸï¼ˆé»˜è®¤30åˆ†é’Ÿï¼‰
    @Value("${token.expireTime}")
    private int expireTime;
    
    /**
     * åˆ›å»ºä»¤ç‰Œ
     */
    public String createToken(LoginUser loginUser) {
        String token = IdUtils.fastUUID();
        loginUser.setToken(token);
        refreshToken(loginUser);
        
        Map<String, Object> claims = new HashMap<>();
        claims.put(Constants.LOGIN_USER_KEY, token);
        return createToken(claims);
    }
    
    /**
     * éªŒè¯ä»¤ç‰Œæœ‰æ•ˆæœŸï¼Œç›¸å·®ä¸è¶³20åˆ†é’Ÿï¼Œè‡ªåŠ¨åˆ·æ–°ç¼“å­˜
     */
    public void verifyToken(LoginUser loginUser) {
        long expireTime = loginUser.getExpireTime();
        long currentTime = System.currentTimeMillis();
        if (expireTime - currentTime <= MILLIS_MINUTE_TEN) {
            refreshToken(loginUser);
        }
    }
}
```

### å¯†ç ç­–ç•¥é…ç½®

```java
@Configuration
public class SecurityConfig {
    
    /**
     * å¯†ç åŠ å¯†æ–¹å¼
     */
    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }
    
    /**
     * è®¤è¯å¤±è´¥å¤„ç†ç±»
     */
    @Bean
    public AuthenticationEntryPoint authenticationEntryPoint() {
        return new AuthenticationEntryPointImpl();
    }
    
    /**
     * æƒé™ä¸è¶³å¤„ç†ç±»
     */
    @Bean
    public AccessDeniedHandler accessDeniedHandler() {
        return new AccessDeniedHandlerImpl();
    }
}
```

## ğŸ”§ å¼‚å¸¸å¤„ç†

### è‡ªå®šä¹‰å¼‚å¸¸ç±»

```java
/**
 * ç”¨æˆ·å¯†ç ä¸æ­£ç¡®æˆ–ä¸ç¬¦åˆè§„èŒƒå¼‚å¸¸ç±»
 */
public class UserPasswordNotMatchException extends UserException {
    public UserPasswordNotMatchException() {
        super("user.password.not.match", null);
    }
}

/**
 * éªŒè¯ç é”™è¯¯å¼‚å¸¸ç±»
 */
public class CaptchaException extends UserException {
    public CaptchaException() {
        super("user.jcaptcha.error", null);
    }
}

/**
 * éªŒè¯ç å¤±æ•ˆå¼‚å¸¸ç±»
 */
public class CaptchaExpireException extends UserException {
    public CaptchaExpireException() {
        super("user.jcaptcha.expire", null);
    }
}
```

### å…¨å±€å¼‚å¸¸å¤„ç†

```java
@RestControllerAdvice
public class GlobalExceptionHandler {
    
    /**
     * ç”¨æˆ·è®¤è¯å¼‚å¸¸
     */
    @ExceptionHandler(UserException.class)
    public AjaxResult handleUserException(UserException e) {
        String message = MessageUtils.message(e.getMessage(), e.getArgs());
        return AjaxResult.error(message);
    }
    
    /**
     * è®¤è¯å¤±è´¥
     */
    @ExceptionHandler(AuthenticationException.class)
    public AjaxResult handleAuthenticationException(AuthenticationException e) {
        return AjaxResult.error("è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•");
    }
}
```

## ğŸ“Š æ¥å£çŠ¶æ€ç è¯´æ˜

| çŠ¶æ€ç  | è¯´æ˜ | å¤‡æ³¨ |
|--------|------|------|
| 200 | æ“ä½œæˆåŠŸ | æ­£å¸¸å“åº” |
| 401 | è®¤è¯å¤±è´¥ | æœªç™»å½•æˆ–tokenè¿‡æœŸ |
| 403 | æƒé™ä¸è¶³ | å·²ç™»å½•ä½†æƒé™ä¸å¤Ÿ |
| 500 | ç³»ç»Ÿå¼‚å¸¸ | æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ |
| 5001 | ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ | ç™»å½•å‡­è¯é”™è¯¯ |
| 5002 | éªŒè¯ç é”™è¯¯ | å›¾å½¢æˆ–çŸ­ä¿¡éªŒè¯ç é”™è¯¯ |
| 5003 | éªŒè¯ç å·²è¿‡æœŸ | éªŒè¯ç è¶…æ—¶ |
| 5004 | è´¦æˆ·å·²è¢«ç¦ç”¨ | ç”¨æˆ·çŠ¶æ€å¼‚å¸¸ |
| 5005 | å¯†ç å·²è¿‡æœŸ | éœ€è¦ä¿®æ”¹å¯†ç  |

## ğŸ” æ•°æ®åº“è¡¨ç»“æ„

### ç”¨æˆ·è¡¨ (sys_user)

```sql
CREATE TABLE `sys_user` (
  `user_id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT 'ç”¨æˆ·ID',
  `dept_id` bigint(20) DEFAULT NULL COMMENT 'éƒ¨é—¨ID',
  `user_name` varchar(30) NOT NULL COMMENT 'ç”¨æˆ·è´¦å·',
  `nick_name` varchar(30) NOT NULL COMMENT 'ç”¨æˆ·æ˜µç§°',
  `user_type` varchar(2) DEFAULT '00' COMMENT 'ç”¨æˆ·ç±»å‹ï¼ˆ00ç³»ç»Ÿç”¨æˆ·ï¼‰',
  `email` varchar(50) DEFAULT '' COMMENT 'ç”¨æˆ·é‚®ç®±',
  `phonenumber` varchar(11) DEFAULT '' COMMENT 'æ‰‹æœºå·ç ',
  `sex` char(1) DEFAULT '0' COMMENT 'ç”¨æˆ·æ€§åˆ«ï¼ˆ0ç”· 1å¥³ 2æœªçŸ¥ï¼‰',
  `avatar` varchar(100) DEFAULT '' COMMENT 'å¤´åƒåœ°å€',
  `password` varchar(100) DEFAULT '' COMMENT 'å¯†ç ',
  `status` char(1) DEFAULT '0' COMMENT 'å¸å·çŠ¶æ€ï¼ˆ0æ­£å¸¸ 1åœç”¨ï¼‰',
  `del_flag` char(1) DEFAULT '0' COMMENT 'åˆ é™¤æ ‡å¿—ï¼ˆ0ä»£è¡¨å­˜åœ¨ 2ä»£è¡¨åˆ é™¤ï¼‰',
  `login_ip` varchar(128) DEFAULT '' COMMENT 'æœ€åç™»å½•IP',
  `login_date` datetime DEFAULT NULL COMMENT 'æœ€åç™»å½•æ—¶é—´',
  `is_first_login` tinyint(1) DEFAULT '1' COMMENT 'æ˜¯å¦é¦–æ¬¡ç™»å½•ï¼ˆ1æ˜¯ 0å¦ï¼‰',
  `create_by` varchar(64) DEFAULT '' COMMENT 'åˆ›å»ºè€…',
  `create_time` datetime DEFAULT NULL COMMENT 'åˆ›å»ºæ—¶é—´',
  `update_by` varchar(64) DEFAULT '' COMMENT 'æ›´æ–°è€…',
  `update_time` datetime DEFAULT NULL COMMENT 'æ›´æ–°æ—¶é—´',
  `remark` varchar(500) DEFAULT NULL COMMENT 'å¤‡æ³¨',
  PRIMARY KEY (`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç”¨æˆ·ä¿¡æ¯è¡¨';
```

### ç™»å½•æ—¥å¿—è¡¨ (sys_logininfor)

```sql
CREATE TABLE `sys_logininfor` (
  `info_id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT 'è®¿é—®ID',
  `user_name` varchar(50) DEFAULT '' COMMENT 'ç”¨æˆ·è´¦å·',
  `ipaddr` varchar(128) DEFAULT '' COMMENT 'ç™»å½•IPåœ°å€',
  `login_location` varchar(255) DEFAULT '' COMMENT 'ç™»å½•åœ°ç‚¹',
  `browser` varchar(50) DEFAULT '' COMMENT 'æµè§ˆå™¨ç±»å‹',
  `os` varchar(50) DEFAULT '' COMMENT 'æ“ä½œç³»ç»Ÿ',
  `status` char(1) DEFAULT '0' COMMENT 'ç™»å½•çŠ¶æ€ï¼ˆ0æˆåŠŸ 1å¤±è´¥ï¼‰',
  `msg` varchar(255) DEFAULT '' COMMENT 'æç¤ºæ¶ˆæ¯',
  `login_time` datetime DEFAULT NULL COMMENT 'è®¿é—®æ—¶é—´',
  PRIMARY KEY (`info_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç³»ç»Ÿè®¿é—®è®°å½•';
```

## ğŸ“ é…ç½®æ–‡ä»¶

### application.yml

```yaml
# tokené…ç½®
token:
  # ä»¤ç‰Œè‡ªå®šä¹‰æ ‡è¯†
  header: Authorization
  # ä»¤ç‰Œå¯†é’¥
  secret: abcdefghijklmnopqrstuvwxyz
  # ä»¤ç‰Œæœ‰æ•ˆæœŸï¼ˆé»˜è®¤30åˆ†é’Ÿï¼‰
  expireTime: 30

# çŸ­ä¿¡é…ç½®
sms:
  # é˜¿é‡Œäº‘çŸ­ä¿¡é…ç½®
  aliyun:
    accessKeyId: your_access_key_id
    accessKeySecret: your_access_key_secret
    signName: ç§‘ç ”ç®¡ç†ç³»ç»Ÿ
    templateCode: SMS_LOGIN_CODE

# Redisé…ç½®
spring:
  redis:
    host: localhost
    port: 6379
    database: 0
    timeout: 10s
    lettuce:
      pool:
        min-idle: 0
        max-idle: 8
        max-active: 8
        max-wait: -1ms
```

---

**ğŸ“ è¯´æ˜**: æ­¤æ¥å£æ–‡æ¡£åŸºäºRuoYi-Vueæ¡†æ¶è®¾è®¡ï¼Œæä¾›å®Œæ•´çš„ç™»å½•è®¤è¯åŠŸèƒ½ï¼ŒåŒ…æ‹¬è´¦å·å¯†ç ç™»å½•ã€æ‰‹æœºéªŒè¯ç ç™»å½•ã€å®‰å…¨éªŒè¯ã€Tokenç®¡ç†ç­‰æ ¸å¿ƒåŠŸèƒ½ï¼Œç¡®ä¿ç³»ç»Ÿå®‰å…¨æ€§å’Œç”¨æˆ·ä½“éªŒã€‚ 